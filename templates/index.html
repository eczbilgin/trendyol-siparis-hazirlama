<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipari≈ü Hazƒ±rlama</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .upload-area {
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .upload-area h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            color: white;
            padding: 15px 40px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            display: inline-block;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .file-label:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }

        .file-name {
            margin-top: 15px;
            color: #666;
            font-size: 0.95em;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .analyze-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.4);
        }

        .analyze-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .stat-box {
            text-align: center;
            padding: 15px 30px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-radius: 10px;
            color: white;
            margin: 10px;
            min-width: 150px;
        }

        .stat-box .number {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .product-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #e74c3c;
        }

        .product-name {
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .product-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-badge {
            background: #ecf0f1;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            color: #34495e;
        }

        .info-badge strong {
            color: #e74c3c;
        }

        .packages {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .packages-title {
            color: #27ae60;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .package-item {
            display: inline-block;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            margin: 5px;
            font-size: 0.9em;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .print-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.3s;
        }

        .print-btn:hover {
            transform: scale(1.05);
        }

        /* Yazdƒ±rma i√ßin kompakt tablo g√∂r√ºn√ºm√º */
        .print-table {
            display: none;
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
        }

        .print-table th, .print-table td {
            border: 1px solid #333;
            padding: 8px 10px;
            text-align: left;
            font-size: 11px;
        }

        .print-table th {
            background: #333;
            color: white;
            font-weight: bold;
        }

        .print-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        @media print {
            @page {
                size: A5 portrait;
                margin: 5mm;
            }
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 8px;
                width: 138mm;
            }
            .container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            .upload-area, .print-btn, .analyze-btn, .summary-card, .product-card, h1, .tabs, .genel-summary {
                display: none !important;
            }
            .print-table {
                display: table !important;
                width: 100%;
                font-size: 7px;
            }
            .print-table th, .print-table td {
                padding: 3px 4px;
                font-size: 7px;
            }
            .print-table th {
                padding: 4px;
                font-size: 8px;
            }
            .print-header {
                display: block !important;
                text-align: center;
                font-size: 10px;
                font-weight: bold;
                margin-bottom: 5px;
            }
            .results {
                display: block !important;
            }
            /* Paket tablosu A5 i√ßin k√º√ß√ºlt */
            .print-table td table {
                font-size: 6px !important;
            }
            .print-table td table th,
            .print-table td table td {
                padding: 1px 2px !important;
                font-size: 6px !important;
            }
        }

        .print-header {
            display: none;
        }

        /* Sekme stilleri */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            background: transparent;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tab-btn.active {
            background: white;
            color: #2c3e50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Genel Sipari≈ü stilleri */
        .barcode-input-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .barcode-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #3498db;
            border-radius: 10px;
            text-align: center;
            outline: none;
        }

        .barcode-input:focus {
            border-color: #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
        }

        .scanned-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .scanned-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            margin: 5px 0;
            border-left: 4px solid #3498db;
        }

        .scanned-item .barcode {
            font-family: monospace;
            color: #666;
            font-size: 0.9em;
        }

        .scanned-item .product-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .scanned-item .quantity {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 10px;
        }

        .genel-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            color: white;
        }

        .genel-summary h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .genel-product-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            margin: 5px 0;
        }

        .clear-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        }

        .clear-btn:hover {
            transform: scale(1.05);
        }

        .scan-count {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        /* Entegra stilleri */
        .entegra-login {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .entegra-login input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
            outline: none;
        }

        .entegra-login input:focus {
            border-color: #3498db;
        }

        .entegra-btn {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            width: 100%;
        }

        .entegra-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(230, 126, 34, 0.4);
        }

        .entegra-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .entegra-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .entegra-status.calisiyor {
            display: block;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .entegra-status.tamamlandi {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .entegra-status.hata {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }

        .entegra-debug {
            margin-top: 10px;
            padding: 10px;
            background: #f1f1f1;
            border-radius: 5px;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
        }

        .veya-ayirici {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #999;
        }

        .veya-ayirici::before,
        .veya-ayirici::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #ddd;
        }

        .veya-ayirici span {
            padding: 0 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sƒ∞PARƒ∞≈û HAZIRLAMA</h1>

        <!-- Sekmeler -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('trendyol')">üõí Trendyol Sipari≈üleri</button>
            <button class="tab-btn" onclick="switchTab('genel')">üì¶ Genel Sipari≈üler</button>
        </div>

        <!-- Trendyol Sekmesi -->
        <div id="trendyol-tab" class="tab-content active">
        <div class="upload-area">
            <h2>Entegra'dan Otomatik √áek</h2>
            <p style="color: #666; margin-bottom: 15px;">Entegra panelinden sipari≈üleri otomatik indir</p>

            <div style="margin-top: 15px;">
                <button class="entegra-btn" id="entegraBtn" onclick="entegraCek()">üåê Entegra'dan √áek</button>
            </div>

            <div class="entegra-status" id="entegraStatus">
                <div id="entegraStatusText"></div>
                <div class="entegra-debug" id="entegraDebug" style="display:none;"></div>
            </div>

            <div class="veya-ayirici"><span>VEYA</span></div>

            <h2>Excel Dosyasƒ± Y√ºkle</h2>
            <p style="color: #666; margin-bottom: 20px;">Trendyol sipari≈ü Excel dosyanƒ±zƒ± (.xlsx) se√ßin</p>

            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx">
                <label for="fileInput" class="file-label">üìÅ Dosya Se√ß</label>
            </div>

            <div class="file-name" id="fileName"></div>

            <br>
            <button class="analyze-btn" id="analyzeBtn" disabled>üîç ANALƒ∞Z ET</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">Analiz ediliyor...</p>
            </div>
        </div>

        <div class="results" id="results">
            <div class="summary-card">
                <h3>üìä GENEL √ñZET</h3>
                <div class="summary-stats">
                    <div class="stat-box">
                        <div class="number" id="urunCesidi">0</div>
                        <div class="label">√úr√ºn √áe≈üidi</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="toplamSiparis">0</div>
                        <div class="label">Toplam Sipari≈ü</div>
                    </div>
                    <div class="stat-box">
                        <div class="number" id="toplamUrun">0</div>
                        <div class="label">Toplam √úr√ºn</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Yazdƒ±r</button>
                </div>
            </div>

            <div id="productList"></div>

            <!-- Karma Sipari≈üler -->
            <div class="summary-card" id="karmaSection" style="display:none; border-left: 5px solid #e67e22;">
                <h3>üîÄ KARMA Sƒ∞PARƒ∞≈ûLER (Birden Fazla √úr√ºn ƒ∞√ßeren)</h3>
                <div id="karmaList"></div>
            </div>

            <!-- Yazdƒ±rma i√ßin kompakt tablo -->
            <div class="print-header" id="printHeader"></div>
            <table class="print-table" id="printTable">
                <thead>
                    <tr>
                        <th style="width:5%">#</th>
                        <th style="width:45%">√úR√úN ADI</th>
                        <th style="width:10%">TOPLAM</th>
                        <th style="width:40%">PAKETLER</th>
                    </tr>
                </thead>
                <tbody id="printTableBody"></tbody>
            </table>
        </div>
        </div><!-- Trendyol sekmesi sonu -->

        <!-- Genel Sipari≈ü Sekmesi -->
        <div id="genel-tab" class="tab-content">
            <div class="upload-area">
                <h2>Genel Sipari≈ü Hazƒ±rlama</h2>
                <p style="color: #666; margin-bottom: 20px;">√ñnce Excel dosyasƒ±nƒ± y√ºkleyin, sonra barkod okutun</p>

                <div class="file-input-wrapper">
                    <input type="file" id="genelFileInput" class="file-input" accept=".xlsx">
                    <label for="genelFileInput" class="file-label">üìÅ Excel Dosyasƒ± Se√ß</label>
                </div>
                <div class="file-name" id="genelFileName"></div>

                <!-- Barkod Okutma Alanƒ± -->
                <div class="barcode-input-area" id="barcodeArea" style="display:none;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üì∑ Barkod Okutun</h3>
                    <input type="text" id="barcodeInput" class="barcode-input" placeholder="Barkodu okutun veya yazƒ±n..." autofocus>
                    <div class="scan-count" id="scanCount">Okutulan: 0 sipari≈ü</div>

                    <!-- Okutulan Barkodlar Listesi -->
                    <div class="scanned-list" id="scannedList"></div>

                    <button class="clear-btn" onclick="clearScannedList()">üóëÔ∏è Listeyi Temizle</button>
                </div>
            </div>

            <!-- Genel Sipari≈ü √ñzeti -->
            <div class="genel-summary" id="genelSummary" style="display:none;">
                <h4>üìä HAZIRLANACAK √úR√úNLER</h4>
                <div id="genelProductList"></div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <strong>Toplam: <span id="genelTotalCount">0</span> adet √ºr√ºn</strong>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="print-btn" onclick="printGenelSiparis()">üñ®Ô∏è Yazdƒ±r</button>
                </div>
            </div>

            <!-- Genel Sipari≈ü Yazdƒ±rma Tablosu -->
            <div class="print-header" id="genelPrintHeader"></div>
            <table class="print-table" id="genelPrintTable">
                <thead>
                    <tr>
                        <th style="width:60%">√úR√úN ADI</th>
                        <th style="width:20%">TOPLAM ADET</th>
                        <th style="width:20%">Sƒ∞PARƒ∞≈û SAYISI</th>
                    </tr>
                </thead>
                <tbody id="genelPrintTableBody"></tbody>
            </table>
        </div><!-- Genel sipari≈ü sekmesi sonu -->
    </div>

    <script>
        // Sekme ge√ßi≈ü fonksiyonu
        function switchTab(tabName) {
            // T√ºm sekmeleri gizle
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Se√ßili sekmeyi g√∂ster
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // ==================== ENTEGRA OTOMATƒ∞K √áEK ====================
        let entegraDurumInterval = null;

        async function entegraCek() {
            const btn = document.getElementById('entegraBtn');
            const status = document.getElementById('entegraStatus');
            const statusText = document.getElementById('entegraStatusText');
            const debug = document.getElementById('entegraDebug');

            btn.disabled = true;
            btn.textContent = '‚è≥ Baƒülanƒ±yor...';
            status.className = 'entegra-status calisiyor';
            status.style.display = 'block';
            statusText.innerHTML = '<div class="spinner" style="width:25px;height:25px;border-width:3px;display:inline-block;vertical-align:middle;margin-right:10px;"></div> Entegra paneline baƒülanƒ±lƒ±yor, tarayƒ±cƒ± a√ßƒ±lacak...';
            debug.style.display = 'none';

            try {
                const response = await fetch('/entegra-cek', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.error) {
                    status.className = 'entegra-status hata';
                    statusText.textContent = data.error;
                    btn.disabled = false;
                    btn.textContent = 'üåê Entegra\'dan √áek';
                    return;
                }

                // Durum kontrol√º ba≈ülat
                entegraDurumKontrol();

            } catch (error) {
                status.className = 'entegra-status hata';
                statusText.textContent = 'Baƒülantƒ± hatasƒ±: ' + error.message;
                btn.disabled = false;
                btn.textContent = 'üåê Entegra\'dan √áek';
            }
        }

        function entegraDurumKontrol() {
            if (entegraDurumInterval) clearInterval(entegraDurumInterval);

            entegraDurumInterval = setInterval(async () => {
                try {
                    const response = await fetch('/entegra-durum');
                    const data = await response.json();

                    const status = document.getElementById('entegraStatus');
                    const statusText = document.getElementById('entegraStatusText');
                    const debug = document.getElementById('entegraDebug');
                    const btn = document.getElementById('entegraBtn');

                    if (data.durum === 'calisiyor') {
                        status.className = 'entegra-status calisiyor';
                        statusText.innerHTML = '<div class="spinner" style="width:25px;height:25px;border-width:3px;display:inline-block;vertical-align:middle;margin-right:10px;"></div> ' + data.mesaj;
                    } else if (data.durum === 'tamamlandi') {
                        clearInterval(entegraDurumInterval);
                        status.className = 'entegra-status tamamlandi';
                        statusText.textContent = '‚úÖ ' + data.mesaj;
                        btn.disabled = false;
                        btn.textContent = 'üåê Entegra\'dan √áek';

                        // Otomatik analiz yap
                        entegraAnaliz();
                    } else if (data.durum === 'hata') {
                        clearInterval(entegraDurumInterval);
                        status.className = 'entegra-status hata';
                        statusText.textContent = '‚ùå ' + data.mesaj;
                        btn.disabled = false;
                        btn.textContent = 'üåê Entegra\'dan √áek';

                        // Debug bilgisi g√∂ster
                        if (data.detay) {
                            debug.style.display = 'block';
                            let debugHTML = '<strong>Sayfa Bilgisi:</strong><br>';
                            debugHTML += `URL: ${data.detay.url}<br>`;
                            debugHTML += `Ba≈ülƒ±k: ${data.detay.title}<br>`;
                            if (data.detay.linkler && data.detay.linkler.length > 0) {
                                debugHTML += '<br><strong>Sayfadaki Linkler:</strong><br>';
                                data.detay.linkler.forEach(l => {
                                    debugHTML += `- ${l.text} (${l.href})<br>`;
                                });
                            }
                            if (data.detay.butonlar && data.detay.butonlar.length > 0) {
                                debugHTML += '<br><strong>Butonlar:</strong><br>';
                                data.detay.butonlar.forEach(b => {
                                    debugHTML += `- ${b}<br>`;
                                });
                            }
                            debug.innerHTML = debugHTML;
                        }
                    }
                } catch (error) {
                    // Sessizce devam et
                }
            }, 2000);
        }

        async function entegraAnaliz() {
            loading.classList.add('show');

            try {
                const response = await fetch('/entegra-analiz', { method: 'POST' });
                const data = await response.json();

                loading.classList.remove('show');

                if (data.error) {
                    alert('Analiz hatasƒ±: ' + data.error);
                    return;
                }

                // Mevcut analiz fonksiyonuyla aynƒ± sonu√ßlarƒ± g√∂ster
                showAnalysisResults(data);

            } catch (error) {
                loading.classList.remove('show');
                alert('Analiz hatasƒ±: ' + error.message);
            }
        }

        // ==================== TRENDYOL Sƒ∞PARƒ∞≈ûLERƒ∞ ====================
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileName.textContent = 'üìÑ ' + this.files[0].name;
                analyzeBtn.disabled = false;
            } else {
                fileName.textContent = '';
                analyzeBtn.disabled = true;
            }
        });

        analyzeBtn.addEventListener('click', async function() {
            const file = fileInput.files[0];
            if (!file) return;

            loading.classList.add('show');
            results.classList.remove('show');
            analyzeBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/analiz', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                loading.classList.remove('show');
                analyzeBtn.disabled = false;

                if (data.error) {
                    alert(data.error);
                    return;
                }

                showAnalysisResults(data);

            } catch (error) {
                loading.classList.remove('show');
                analyzeBtn.disabled = false;
                alert('Bir hata olu≈ütu: ' + error.message);
            }
        });

        // ==================== ANALƒ∞Z SONU√áLARINI G√ñSTER ====================
        function showAnalysisResults(data) {
            // √ñzet bilgileri g√ºncelle
            document.getElementById('urunCesidi').textContent = data.ozet.urun_cesidi;
            document.getElementById('toplamSiparis').textContent = data.ozet.toplam_siparis;
            document.getElementById('toplamUrun').textContent = data.ozet.toplam_urun;

            // √úr√ºn listesini olu≈ütur
            const productList = document.getElementById('productList');
            const printTableBody = document.getElementById('printTableBody');
            const printHeader = document.getElementById('printHeader');
            productList.innerHTML = '';
            printTableBody.innerHTML = '';

            // Yazdƒ±rma ba≈ülƒ±ƒüƒ±
            const tarih = new Date().toLocaleDateString('tr-TR');
            printHeader.innerHTML = `Sƒ∞PARƒ∞≈û HAZIRLAMA Lƒ∞STESƒ∞ - ${tarih}<br>Toplam: ${data.ozet.urun_cesidi} √ºr√ºn, ${data.ozet.toplam_urun} adet`;

            let siraNo = 1;
            data.urunler.forEach(urun => {
                const card = document.createElement('div');
                card.className = 'product-card';

                let paketlerHTML = '';
                let paketlerText = '<table style="width:100%;border-collapse:collapse;font-size:10px;"><tr><th style="border:1px solid #666;padding:2px;background:#eee;">√úr√ºn Adedi</th><th style="border:1px solid #666;padding:2px;background:#eee;">Paket</th></tr>';
                urun.paketler.forEach(p => {
                    paketlerHTML += `<span class="package-item">${p.sayi} adet ${p.adet}'li</span>`;
                    paketlerText += `<tr><td style="border:1px solid #666;padding:2px;text-align:center;">${p.adet}</td><td style="border:1px solid #666;padding:2px;text-align:center;">${p.sayi}</td></tr>`;
                });
                paketlerText += '</table>';

                card.innerHTML = `
                    <div class="product-name">üì¶ ${urun.urun}</div>
                    <div class="product-info">
                        <span class="info-badge">Toplam: <strong>${urun.toplam} adet</strong></span>
                        <span class="info-badge">Sipari≈ü: <strong>${urun.siparis_sayisi}</strong></span>
                    </div>
                    <div class="packages">
                        <div class="packages-title">üè∑Ô∏è Paket Hazƒ±rlama:</div>
                        ${paketlerHTML}
                    </div>
                `;
                productList.appendChild(card);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${siraNo}</td>
                    <td>${urun.urun}</td>
                    <td><strong>${urun.toplam}</strong></td>
                    <td>${paketlerText}</td>
                `;
                printTableBody.appendChild(row);
                siraNo++;
            });

            // Karma sipari≈üleri g√∂ster
            const karmaSection = document.getElementById('karmaSection');
            const karmaList = document.getElementById('karmaList');
            karmaList.innerHTML = '';

            if (data.karma_siparisler && data.karma_siparisler.length > 0) {
                karmaSection.style.display = 'block';

                data.karma_siparisler.forEach(siparis => {
                    const karmaCard = document.createElement('div');
                    karmaCard.style.cssText = 'background:#fff8e7;border-radius:10px;padding:15px;margin:10px 0;border-left:4px solid #e67e22;';

                    let urunlerHTML = '';
                    siparis.urunler.forEach(u => {
                        urunlerHTML += `<div style="padding:5px 0;border-bottom:1px solid #eee;"><strong>${u.urun}</strong> - ${u.adet} adet</div>`;
                    });

                    karmaCard.innerHTML = `
                        <div style="font-weight:bold;color:#e67e22;margin-bottom:10px;">üì¶ Sipari≈ü No: ${siparis.siparis_no}</div>
                        ${urunlerHTML}
                    `;
                    karmaList.appendChild(karmaCard);
                });

                const separatorRow = document.createElement('tr');
                separatorRow.innerHTML = `
                    <td colspan="4" style="background:#e67e22;color:white;text-align:center;font-weight:bold;padding:10px;">
                        üîÄ KARMA Sƒ∞PARƒ∞≈ûLER (Birden Fazla √úr√ºn ƒ∞√ßeren)
                    </td>
                `;
                printTableBody.appendChild(separatorRow);

                data.karma_siparisler.forEach(siparis => {
                    const karmaRow = document.createElement('tr');
                    karmaRow.style.backgroundColor = '#fff8e7';

                    let urunAdlariHTML = siparis.urunler.map(u => u.urun).join('<br>');
                    let toplamAdet = siparis.urunler.reduce((sum, u) => sum + u.adet, 0);

                    let paketDetayHTML = '<table style="width:100%;border-collapse:collapse;font-size:10px;"><tr><th style="border:1px solid #666;padding:2px;background:#f5d6a8;">√úr√ºn</th><th style="border:1px solid #666;padding:2px;background:#f5d6a8;">Adet</th></tr>';
                    siparis.urunler.forEach(u => {
                        paketDetayHTML += `<tr><td style="border:1px solid #666;padding:2px;">${u.urun}</td><td style="border:1px solid #666;padding:2px;text-align:center;">${u.adet}</td></tr>`;
                    });
                    paketDetayHTML += '</table>';

                    karmaRow.innerHTML = `
                        <td style="background:#e67e22;color:white;font-weight:bold;">${siraNo}</td>
                        <td style="font-size:10px;">${urunAdlariHTML}</td>
                        <td><strong>${toplamAdet}</strong></td>
                        <td>${paketDetayHTML}</td>
                    `;
                    printTableBody.appendChild(karmaRow);
                    siraNo++;
                });
            } else {
                karmaSection.style.display = 'none';
            }

            results.classList.add('show');
        }

        // ==================== GENEL Sƒ∞PARƒ∞≈ûLER ====================
        const genelFileInput = document.getElementById('genelFileInput');
        const genelFileName = document.getElementById('genelFileName');
        const barcodeArea = document.getElementById('barcodeArea');
        const barcodeInput = document.getElementById('barcodeInput');
        const scannedList = document.getElementById('scannedList');
        const genelSummary = document.getElementById('genelSummary');
        const genelProductList = document.getElementById('genelProductList');
        const scanCount = document.getElementById('scanCount');

        let excelData = {}; // Barkod -> {urun, adet} e≈üle≈ütirmesi
        let scannedBarcodes = []; // Okutulan barkodlar

        // Excel dosyasƒ± y√ºklendiƒüinde
        genelFileInput.addEventListener('change', async function() {
            if (this.files.length > 0) {
                genelFileName.textContent = 'üìÑ ' + this.files[0].name;

                const formData = new FormData();
                formData.append('file', this.files[0]);

                try {
                    const response = await fetch('/genel-analiz', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Excel verilerini sakla
                    excelData = data.barkodlar;
                    barcodeArea.style.display = 'block';
                    barcodeInput.focus();

                    alert(`Excel y√ºklendi! ${Object.keys(excelData).length} farklƒ± barkod bulundu.`);

                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        });

        // Barkod okutulduƒüunda
        barcodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const barcode = this.value.trim();
                if (barcode === '') return;

                // Daha √∂nce okutulmu≈ü mu kontrol et - sessizce ge√ß
                const dahaOnceOkutuldu = scannedBarcodes.some(item => item.barcode === barcode);
                if (dahaOnceOkutuldu) {
                    this.value = '';
                    this.focus();
                    return;
                }

                if (excelData[barcode]) {
                    // Barkod bulundu - birden fazla √ºr√ºn olabilir
                    const urunler = excelData[barcode];
                    scannedBarcodes.push({
                        barcode: barcode,
                        urunler: urunler // [{urun, adet}, {urun, adet}, ...]
                    });

                    updateScannedList();
                    updateGenelSummary();
                } else {
                    alert('‚ö†Ô∏è Barkod bulunamadƒ±: ' + barcode);
                }

                this.value = '';
                this.focus();
            }
        });

        // Okutulan barkodlar listesini g√ºncelle
        function updateScannedList() {
            scannedList.innerHTML = '';
            scanCount.textContent = `Okutulan: ${scannedBarcodes.length} sipari≈ü`;

            scannedBarcodes.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'scanned-item';
                div.style.flexDirection = 'column';
                div.style.alignItems = 'stretch';

                // Birden fazla √ºr√ºn olabilir
                let urunlerHTML = '';
                let toplamAdet = 0;
                item.urunler.forEach(u => {
                    urunlerHTML += `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #eee;">
                        <span>${u.urun}</span>
                        <span class="quantity" style="font-size:0.85em;padding:2px 10px;">${u.adet} adet</span>
                    </div>`;
                    toplamAdet += u.adet;
                });

                div.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div class="barcode" style="font-weight:bold;">${item.barcode}</div>
                        <button class="remove-btn" onclick="removeScanned(${index})">√ó</button>
                    </div>
                    <div style="font-size:0.9em;">${urunlerHTML}</div>
                `;
                scannedList.appendChild(div);
            });
        }

        // Barkodu listeden √ßƒ±kar
        function removeScanned(index) {
            scannedBarcodes.splice(index, 1);
            updateScannedList();
            updateGenelSummary();
        }

        // Listeyi temizle
        function clearScannedList() {
            if (confirm('T√ºm okutulan barkodlarƒ± silmek istediƒüinize emin misiniz?')) {
                scannedBarcodes = [];
                updateScannedList();
                updateGenelSummary();
            }
        }

        // Genel sipari≈ü √∂zetini g√ºncelle
        function updateGenelSummary() {
            if (scannedBarcodes.length === 0) {
                genelSummary.style.display = 'none';
                return;
            }

            genelSummary.style.display = 'block';

            // √úr√ºnleri grupla
            const urunGruplari = {};
            scannedBarcodes.forEach(item => {
                // Her barkodda birden fazla √ºr√ºn olabilir
                item.urunler.forEach(u => {
                    if (!urunGruplari[u.urun]) {
                        urunGruplari[u.urun] = {
                            toplam: 0,
                            siparisSayisi: 0
                        };
                    }
                    urunGruplari[u.urun].toplam += u.adet;
                    urunGruplari[u.urun].siparisSayisi += 1;
                });
            });

            // Listeyi olu≈ütur
            genelProductList.innerHTML = '';
            let toplamAdet = 0;

            Object.keys(urunGruplari).sort().forEach(urun => {
                const bilgi = urunGruplari[urun];
                toplamAdet += bilgi.toplam;

                const div = document.createElement('div');
                div.className = 'genel-product-item';
                div.innerHTML = `
                    <span>${urun}</span>
                    <span><strong>${bilgi.toplam}</strong> adet (${bilgi.siparisSayisi} sipari≈ü)</span>
                `;
                genelProductList.appendChild(div);
            });

            document.getElementById('genelTotalCount').textContent = toplamAdet;

            // Yazdƒ±rma tablosunu g√ºncelle
            updateGenelPrintTable(urunGruplari, toplamAdet);
        }

        // Genel sipari≈ü yazdƒ±rma tablosunu g√ºncelle
        function updateGenelPrintTable(urunGruplari, toplamAdet) {
            const printHeader = document.getElementById('genelPrintHeader');
            const printBody = document.getElementById('genelPrintTableBody');

            const tarih = new Date().toLocaleDateString('tr-TR');
            const siparisSayisi = scannedBarcodes.length;
            printHeader.innerHTML = `GENEL Sƒ∞PARƒ∞≈û Lƒ∞STESƒ∞ - ${tarih}<br>Okutulan Sipari≈ü: ${siparisSayisi} | Toplam: ${Object.keys(urunGruplari).length} √ºr√ºn, ${toplamAdet} adet`;

            printBody.innerHTML = '';

            Object.keys(urunGruplari).sort().forEach(urun => {
                const bilgi = urunGruplari[urun];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${urun}</td>
                    <td><strong>${bilgi.toplam}</strong></td>
                    <td>${bilgi.siparisSayisi}</td>
                `;
                printBody.appendChild(row);
            });
        }

        // Genel sipari≈ü yazdƒ±r
        function printGenelSiparis() {
            // Ge√ßici olarak trendyol tablosunu gizle, genel tabloyu g√∂ster
            document.getElementById('printTable').style.display = 'none';
            document.getElementById('printHeader').style.display = 'none';
            document.getElementById('genelPrintTable').style.display = 'table';
            document.getElementById('genelPrintHeader').style.display = 'block';

            window.print();

            // Geri al
            document.getElementById('printTable').style.display = '';
            document.getElementById('printHeader').style.display = '';
            document.getElementById('genelPrintTable').style.display = 'none';
            document.getElementById('genelPrintHeader').style.display = 'none';
        }
    </script>
</body>
</html>
